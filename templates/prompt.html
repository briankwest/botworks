{% extends 'base.html' %}

{% block title %}Prompts{% endblock %}

{% block content %}
  <!-- Navbar -->
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'sidebar.html' %}
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-6">
          <h1 class="m-0">Prompt Editor</h1>
        </div>
      </div>
    </div><!-- /.container-fluid -->
  </section>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <!-- DataTable for existing prompts -->
          <div class="card card-primary">
            <div class="card-header">
              <h3 class="card-title">Existing Prompts</h3>
            </div>
            <div class="card-body">
              <table id="promptTable" class="table table-striped w-100">
                <thead>
                  <tr>
                    <th>ID</th> <!-- New column for ID -->
                    <th>Type</th>
                    <th>Text</th>
                    <th>Top P</th>
                    <th>Temperature</th>
                    <th>Max Tokens</th>
                    <th>Confidence</th>
                    <th>Frequency Penalty</th>
                    <th>Presence Penalty</th>
                    <th>Actions</th> <!-- New column for actions -->
                  </tr>
                </thead>
                <tbody>
                  {% for prompt in prompts %}
                  <tr>
                    <td>{{ prompt.id }}</td> <!-- Display the ID -->
                    <td>{{ prompt.prompt_type }}</td>
                    <td>{{ prompt.prompt_text }}</td>
                    <td>{{ prompt.top_p }}</td>
                    <td>{{ prompt.temperature }}</td>
                    <td>{{ prompt.max_tokens }}</td>
                    <td>{{ prompt.confidence }}</td>
                    <td>{{ prompt.frequency_penalty }}</td>
                    <td>{{ prompt.presence_penalty }}</td>
                    <td>
                      <button class="btn btn-sm btn-primary edit-btn" data-id="{{ prompt.id }}">Edit</button>
                      <button class="btn btn-sm btn-danger delete-btn" data-id="{{ prompt.id }}">Delete</button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <!-- /.card -->

          <!-- Form to add new prompts -->
          <div class="card card-primary">
            <div class="card-header bg-success">
              <h3 class="card-title">Add New Prompt</h3>
            </div>
            <form id="addPromptForm">
              <div class="card-body">
                <div class="form-group">
                  <label for="newPromptType">Prompt Type</label>
                  <select class="form-control" id="newPromptType" name="prompt_type" required>
                    <option value="">Select a type</option>
                    {% for type in ['prompt', 'post_prompt', 'outbound_prompt', 'outbound_post_prompt'] %}
                      {% if type not in existing_prompt_types %}
                        <option value="{{ type }}">{{ type }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <div class="form-group">
                  <label for="newPromptText">Prompt Text</label>
                  <textarea class="form-control" id="newPromptText" name="prompt_text" rows="3" required>Hello, how are you today?</textarea>
                </div>
                <!-- Add other input fields similar to the existing form -->
                <div class="form-group">
                  <label for="newTopP">Top P</label>
                  <input type="range" class="form-control-range" id="newTopP" name="top_p" min="0" max="2" step="0.1" value="0.5" required>
                  <span id="newTopPValue">0.5</span>
                </div>
                <div class="form-group">
                  <label for="newTemperature">Temperature</label>
                  <input type="range" class="form-control-range" id="newTemperature" name="temperature" min="0" max="2" step="0.1" value="0.5" required>
                  <span id="newTemperatureValue">0.5</span>
                </div>
                <div class="form-group">
                  <label for="newMaxTokens">Max Tokens</label>
                  <input type="number" class="form-control" id="newMaxTokens" name="max_tokens" min="0" max="1000" value="1000" required>
                </div>
                <div class="form-group">
                  <label for="newConfidence">Confidence</label>
                  <input type="number" class="form-control" id="newConfidence" name="confidence" min="0" step="0.1" value="0.1" required>
                </div>
                <div class="form-group">
                  <label for="newFrequencyPenalty">Frequency Penalty</label>
                  <input type="range" class="form-control-range" id="newFrequencyPenalty" name="frequency_penalty" min="-2" max="2" step="0.1" value="0">
                  <span id="newFrequencyPenaltyValue">0</span>
                </div>
                <div class="form-group">
                  <label for="newPresencePenalty">Presence Penalty</label>
                  <input type="range" class="form-control-range" id="newPresencePenalty" name="presence_penalty" min="-2" max="2" step="0.1" value="0">
                  <span id="newPresencePenaltyValue">0</span>
                </div>
              </div>
              <div class="card-footer">
                <button type="submit" class="btn btn-success">Add Prompt</button>
              </div>
            </form>
          </div>
         <!-- /.card -->

          <!-- Edit Modal -->
          <div class="modal fade" id="editPromptModal" tabindex="-1" role="dialog" aria-labelledby="editPromptModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editPromptModalLabel">Edit Prompt</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <form id="editPromptForm">
                    <div class="form-group">
                      <label for="editPromptType">Prompt Type</label>
                      <select class="form-control" id="editPromptType" name="prompt_type" required>
                        {% for type in ['prompt', 'post_prompt', 'outbound_prompt', 'outbound_post_prompt'] %}
                          <option value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="editPromptText">Prompt Text</label>
                      <textarea class="form-control" id="editPromptText" name="prompt_text" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="editTopP">Top P</label>
                      <input type="range" class="form-control-range" id="editTopP" name="top_p" min="0" max="2" step="0.1" required>
                      <span id="editTopPValue">0.5</span>
                    </div>
                    <div class="form-group">
                      <label for="editTemperature">Temperature</label>
                      <input type="range" class="form-control-range" id="editTemperature" name="temperature" min="0" max="2" step="0.1" required>
                      <span id="editTemperatureValue">0.5</span>
                    </div>
                    <div class="form-group">
                      <label for="editMaxTokens">Max Tokens</label>
                      <input type="number" class="form-control" id="editMaxTokens" name="max_tokens" min="0" max="1000" required>
                    </div>
                    <div class="form-group">
                      <label for="editConfidence">Confidence</label>
                      <input type="number" class="form-control" id="editConfidence" name="confidence" min="0" step="0.1" required>
                    </div>
                    <div class="form-group">
                      <label for="editFrequencyPenalty">Frequency Penalty</label>
                      <input type="range" class="form-control-range" id="editFrequencyPenalty" name="frequency_penalty" min="-2" max="2" step="0.1" value="0">
                      <span id="editFrequencyPenaltyValue">0</span>
                    </div>
                    <div class="form-group">
                      <label for="editPresencePenalty">Presence Penalty</label>
                      <input type="range" class="form-control-range" id="editPresencePenalty" name="presence_penalty" min="-2" max="2" step="0.1" value="0">
                      <span id="editPresencePenaltyValue">0</span>
                    </div>
                    <!-- Hidden input for storing the prompt ID -->
                    <input type="hidden" id="editPromptId" name="id">
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" id="saveEditPrompt">Save changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- /.row -->
    </div><!-- /.container-fluid -->
  </section>
  <!-- /.content -->
</div>
  <!-- Footer -->
  {% include 'footer.html' %}
  <!-- /.footer -->
{% endblock %}

{% block scripts %}
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
  <!-- DataTables JS -->
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
  <script>
    // Function to show toast notification
    function showToast(icon, title) {
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer)
          toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      });

      Toast.fire({
        icon: icon,
        title: title
      });
    }

    $(document).ready(function() {
      // Fetch data from /prompt endpoint
      $.ajax({
        type: 'GET',
        url: "{{ url_for('prompt') }}",
        headers: {
          'Accept': 'application/json'
        },
        success: function(data) {
          // Ensure data is an array
          const prompts = Array.isArray(data) ? data : [data];

          // Initialize DataTable with fetched data
          $('#promptTable').DataTable({
            data: prompts,
            columns: [
              { data: 'id' }, // New column for ID
              { data: 'prompt_type' },
              { data: 'prompt_text' },
              { data: 'top_p' },
              { data: 'temperature' },
              { data: 'max_tokens' },
              { data: 'confidence' },
              { data: 'frequency_penalty' },
              { data: 'presence_penalty' },
              {
                data: null,
                defaultContent: '<button class="btn btn-sm btn-primary edit-btn">Edit</button> <button class="btn btn-sm btn-danger delete-btn">Delete</button>',
                orderable: false
              }
            ],
            "responsive": true,
            "autoWidth": false,
            "order": [0, 'asc'], // Order by ID
            "paging": true,
            "lengthChange": true,
            "searching": true,
            "info": true
          });

          // Handle edit button click
          $('#promptTable tbody').on('click', '.edit-btn', function() {
            const data = $('#promptTable').DataTable().row($(this).parents('tr')).data();
            $('#editPromptId').val(data.id);
            $('#editPromptType').val(data.prompt_type);
            $('#editPromptText').val(data.prompt_text);
            $('#editTopP').val(data.top_p);
            $('#editTemperature').val(data.temperature);
            $('#editMaxTokens').val(data.max_tokens);
            $('#editConfidence').val(data.confidence);
            $('#editFrequencyPenalty').val(data.frequency_penalty);
            $('#editPresencePenalty').val(data.presence_penalty);
            $('#editPromptModal').modal('show'); // Ensure Bootstrap JS is loaded
          });

          // Handle delete button click
          $('#promptTable tbody').on('click', '.delete-btn', function() {
            const data = $('#promptTable').DataTable().row($(this).parents('tr')).data();
            Swal.fire({
              title: 'Are you sure?',
              text: "You won't be able to revert this!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
              if (result.isConfirmed) {
                $.ajax({
                  type: 'DELETE',
                  url: "{{ url_for('prompt') }}/" + data.id,
                  success: function(response) {
                    showToast('success', 'Prompt deleted successfully');
                    location.reload(); // Reload the page to update the table
                  },
                  error: function(xhr, status, error) {
                    showToast('error', 'Error deleting prompt: ' + xhr.responseText);
                  }
                });
              }
            });
          });
        },
        error: function(xhr, status, error) {
          showToast('error', 'Error loading prompts: ' + xhr.responseText);
        }
      });

      // Handle form submission for adding new prompts
      $('#addPromptForm').submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        const formData = {
          prompt_type: $('#newPromptType').val(),
          prompt_text: $('#newPromptText').val(),
          top_p: parseFloat($('#newTopP').val()),
          temperature: parseFloat($('#newTemperature').val()),
          max_tokens: parseInt($('#newMaxTokens').val()),
          confidence: parseFloat($('#newConfidence').val()),
          frequency_penalty: parseFloat($('#newFrequencyPenalty').val()),
          presence_penalty: parseFloat($('#newPresencePenalty').val())
          // Ensure no ID is included in the formData
        };

        $.ajax({
          type: 'POST', // Use POST instead of GET
          url: "{{ url_for('prompt') }}", // Ensure this is the correct endpoint
          contentType: 'application/json',
          dataType: 'json',
          data: JSON.stringify(formData),
          success: function(response) {
            showToast('success', 'New prompt added successfully');
            
            // Fetch the updated data and reload the DataTable
            $.ajax({
              type: 'GET',
              url: "{{ url_for('prompt') }}",
              headers: {
                'Accept': 'application/json'
              },
              success: function(data) {
                const prompts = Array.isArray(data) ? data : [data];
                const table = $('#promptTable').DataTable();
                table.clear().rows.add(prompts).draw();
              },
              error: function(xhr, status, error) {
                showToast('error', 'Error reloading prompts: ' + xhr.responseText);
              }
            });

            // Clear the form
            $('#addPromptForm')[0].reset();
          },
          error: function(xhr, status, error) {
            showToast('error', 'Error adding new prompt: ' + xhr.responseText);
          }
        });
      });

      // Handle save changes button click in edit modal
      $('#saveEditPrompt').click(function() {
        const formData = {
          prompt_type: $('#editPromptType').val(),
          prompt_text: $('#editPromptText').val(),
          top_p: parseFloat($('#editTopP').val()),
          temperature: parseFloat($('#editTemperature').val()),
          max_tokens: parseInt($('#editMaxTokens').val()),
          confidence: parseFloat($('#editConfidence').val()),
          frequency_penalty: parseFloat($('#editFrequencyPenalty').val()),
          presence_penalty: parseFloat($('#editPresencePenalty').val())
        };

        const promptId = $('#editPromptId').val(); // Get the prompt ID

        $.ajax({
          type: 'PUT',
          url: "{{ url_for('prompt') }}/" + promptId, // Include the ID in the URL
          contentType: 'application/json',
          dataType: 'json',
          data: JSON.stringify(formData),
          success: function(response) {
            showToast('success', 'Prompt updated successfully');
            $('#editPromptModal').modal('hide');
            location.reload(); // Reload the page to update the table
          },
          error: function(xhr, status, error) {
            showToast('error', 'Error updating prompt: ' + xhr.responseText);
          }
        });
      });

      // Update displayed value for new prompt sliders
      $('#newTopP').on('input', function() {
        $('#newTopPValue').text($(this).val());
      });

      $('#newTemperature').on('input', function() {
        $('#newTemperatureValue').text($(this).val());
      });

      $('#newFrequencyPenalty').on('input', function() {
        $('#newFrequencyPenaltyValue').text($(this).val());
      });

      $('#newPresencePenalty').on('input', function() {
        $('#newPresencePenaltyValue').text($(this).val());
      });

      // Update displayed value for edit prompt sliders
      $('#editTopP').on('input', function() {
        $('#editTopPValue').text($(this).val());
      });

      $('#editTemperature').on('input', function() {
        $('#editTemperatureValue').text($(this).val());
      });

      $('#editFrequencyPenalty').on('input', function() {
        $('#editFrequencyPenaltyValue').text($(this).val());
      });

      $('#editPresencePenalty').on('input', function() {
        $('#editPresencePenaltyValue').text($(this).val());
      });
    });
  </script>
{% endblock %}
