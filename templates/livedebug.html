{% extends 'base.html' %}

{% block title %}Dynamic WebSocket Channels{% endblock %}

{% block content %}
  <!-- Navbar -->
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'sidebar.html' %}
  
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-6">
                    <h1 class="m-0">Live Debug</h1>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h3 class="card-title">Live Debug</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <label for="channel">Channel:</label>
                            <input id="channel" type="text" placeholder="Enter channel name">
                            <button onclick="joinChannel()">Join Channel</button>
                            <button onclick="leaveChannel()">Leave Channel</button>

                            <h2>Messages:</h2>
                            <ul id="messages"></ul>

                            <input id="message" type="text" placeholder="Enter message">
                            <button onclick="sendMessage()">Send Message</button>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <!-- Footer -->
  {% include 'footer.html' %}
  <!-- /.footer -->
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get access_token from cookies
    const accessToken = getCookie('access_token');

    // Initialize socket with access_token
    const socket = io({
      transports: ['websocket'],
      auth: {
        token: accessToken
      }
    });

    let currentChannel = '{{ channel}}';
    document.getElementById('channel').value = currentChannel;

    function updateMessagesList(message) {
      const li = document.createElement("li");
      li.textContent = message;
      document.getElementById('messages').appendChild(li);
    }

    function joinChannel() {
      currentChannel = document.getElementById('channel').value;
      if (currentChannel) {
        socket.emit('join', { channel: currentChannel });
        // Removed alert for joining channel
      }
    }

    function leaveChannel() {
      if (currentChannel) {
        socket.emit('leave', { channel: currentChannel });
        currentChannel = '';
      }
    }

    function sendMessage() {
      const message = document.getElementById('message').value;
      if (currentChannel && message) {
        const messageData = {
          channel: currentChannel,
          message: message
        };
        socket.emit('send_message', messageData);
      }
    }

    socket.on('send_message', function(data) {
      updateMessagesList(`Sent: [${data.channel}] ${data.message}`);
    });

    socket.on('response', function(data) {
      if (data instanceof ArrayBuffer) {
        const decoder = new TextDecoder('utf-8');
        const decodedMessage = decoder.decode(data);
        updateMessagesList(`[${data.channel}] ${decodedMessage}`);
      } else {
        updateMessagesList(`[${data.channel}] ${data.data}`);
      }
    });

    socket.on('status', function(data) {
      // Use Swal toast instead of alert
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: data.message,
        showConfirmButton: false,
        timer: 3000
      });
    });

    // Expose functions to global scope
    window.joinChannel = joinChannel;
    window.leaveChannel = leaveChannel;
    window.sendMessage = sendMessage;
  });
</script>
{% endblock %}
