{% extends 'base.html' %}

{% block title %}SWAIG Functions{% endblock %}

{% block content %}
  <!-- Navbar -->
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'sidebar.html' %}

  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0">SWAIG Functions</h1>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Functions List</h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <table id="functionTable" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Purpose</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- Add Function Form -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Add Function Entry</h3>
              </div>
              <!-- /.card-header -->
              <div class="card-body">
                <form id="addFunctionForm">
                  <div class="form-group">
                    <label for="functionName">Function Name</label>
                    <input type="text" class="form-control" id="functionName" name="name" required>
                  </div>
                  <div class="form-group">
                    <label for="functionPurpose">Function Purpose</label>
                    <input type="text" class="form-control" id="functionPurpose" name="purpose" required>
                  </div>
                  <button type="submit" class="btn btn-primary">Add Function</button>
                </form>
              </div>
              <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
          <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- Edit Function Modal -->
        <div class="modal fade" id="editFunctionModal" tabindex="-1" role="dialog" aria-labelledby="editFunctionModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editFunctionModalLabel">Edit Function</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form id="editFunctionForm">
                  <input type="hidden" id="editFunctionId" name="id">
                  <div class="form-group">
                    <label for="editFunctionName">Function Name</label>
                    <input type="text" class="form-control" id="editFunctionName" name="name" required>
                  </div>
                  <div class="form-group">
                    <label for="editFunctionPurpose">Function Purpose</label>
                    <input type="text" class="form-control" id="editFunctionPurpose" name="purpose" required>
                  </div>
                </form>
                <hr>
                <h6>Function Arguments</h6>
                <table class="table table-bordered" id="functionArgsTable">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Description</th>
                      <th>Required</th>
                      <th>Enum</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="functionArgsBody">
                    <!-- Function arguments will be dynamically added here -->
                  </tbody>
                </table>
                <button type="button" class="btn btn-success" id="addNewArg">Add New Argument</button>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditFunction">Save changes</button>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
     <!-- Footer -->
  {% include 'footer.html' %}
  <!-- /.footer -->
{% endblock %}

{% block scripts %}
  <!-- Add DataTables CSS and JS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
  <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>
    <!-- Add Bootstrap JS -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function() {
      // Initialize DataTable
      $('#functionTable').DataTable({
        "ajax": {
          "url": "{{ url_for('get_functions') }}",
          "dataSrc": ""
        },
        "columns": [
          { "data": "id" },
          { "data": "name" },
          { "data": "purpose" },
          {
            "data": null,
            "render": function(data, type, row) {
              return `
                <button class="btn btn-primary btn-sm edit-function" data-id="${row.id}">Edit</button>
                <button class="btn btn-danger btn-sm delete-function" data-id="${row.id}">Delete</button>
              `;
            }
          }
        ]
      });

      // Add event listeners for delete buttons
      $('#functionTable').on('click', '.delete-function', function() {
        const functionId = $(this).data('id');
        if (confirm('Are you sure you want to delete this function?')) {
          fetch(`/functions/${functionId}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data.message === 'Function entry deleted successfully') {
              location.reload();
            } else {
              alert('Error deleting function');
            }
          })
          .catch(error => {
            console.error('Error deleting function:', error);
            alert('Error deleting function');
          });
        }
      });

      // Add event listeners for edit buttons
      $('#functionTable').on('click', '.edit-function', function() {
        const functionId = $(this).data('id');
        // Fetch function details to populate the modal
        fetch(`/functions/${functionId}`)
          .then(response => response.json())
          .then(data => {
            $('#editFunctionId').val(data.id);
            $('#editFunctionName').val(data.name);
            $('#editFunctionPurpose').val(data.purpose);

            loadFunctionArgs(functionId);

            $('#editFunctionModal').modal('show'); // Ensure this line is present
          })
          .catch(error => {
            console.error('Error fetching function details:', error);
            alert('Error loading function details');
          });
      });

      function loadFunctionArgs(functionId) {
        fetch(`/functions/${functionId}/args`)
          .then(response => response.json())
          .then(args => {
            const argsBody = $('#functionArgsBody');
            argsBody.empty(); // Clear existing rows
            args.forEach(arg => {
              argsBody.append(createArgRow(arg));
            });
          })
          .catch(error => {
            console.error('Error loading function arguments:', error);
            alert('Error loading function arguments');
          });
      }

      function createArgRow(arg) {
        return `
          <tr data-arg-id="${arg.id}">
            <td><input type="text" class="form-control" name="arg_name" value="${arg.name}" required></td>
            <td>
              <select class="form-control" name="arg_type" required>
                <option value="string" ${arg.type === 'string' ? 'selected' : ''}>String</option>
                <option value="integer" ${arg.type === 'integer' ? 'selected' : ''}>Integer</option>
                <option value="boolean" ${arg.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                <option value="array" ${arg.type === 'array' ? 'selected' : ''}>Array</option>
              </select>
            </td>
            <td><input type="text" class="form-control" name="arg_description" value="${arg.description || ''}"></td>
            <td><input type="checkbox" name="arg_required" ${arg.required ? 'checked' : ''}></td>
            <td>
              <div class="enum-field" style="display: ${arg.type === 'array' ? 'block' : 'none'};">
                <input type="text" class="form-control" name="arg_enum" value="${arg.enum || ''}" placeholder="Comma-separated list of valid items">
              </div>
              <div class="placeholder-field" style="display: ${arg.type !== 'array' ? 'block' : 'none'};">
                <input type="text" class="form-control" name="arg_placeholder" value="" placeholder="N/A" readonly>
              </div>
            </td>
            <td>
              <button type="button" class="btn btn-sm btn-danger delete-arg" data-id="${arg.id}">Delete</button>
            </td>
          </tr>
        `;
      }

      // Add event listener to toggle enum field visibility based on type selection
      $('#functionArgsBody').on('change', 'select[name="arg_type"]', function() {
        const $row = $(this).closest('tr');
        const isArrayType = $(this).val() === 'array';
        $row.find('.enum-field').toggle(isArrayType);
        $row.find('.placeholder-field').toggle(!isArrayType);
      });

      $('#addNewArg').on('click', function() {
        const newArg = {
          id: 'new_' + Date.now(),
          name: '',
          type: '',
          description: '',
          required: false,
          enum: ''
        };
        $('#functionArgsBody').append(createArgRow(newArg));
      });

      $('#functionArgsBody').on('click', '.delete-arg', function() {
        const $row = $(this).closest('tr');
        const argId = $row.data('arg-id'); // Ensure this is correctly set

        if (typeof argId === 'string' && argId.startsWith('new_')) {
          $row.remove();
        } else {
          if (confirm('Are you sure you want to delete this argument?')) {
            fetch(`/functions/${$('#editFunctionId').val()}/args/${argId}`, {
              method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
              if (data.message === 'Function argument deleted successfully') {
                $row.remove();
              } else {
                alert('Error deleting argument');
              }
            })
            .catch(error => {
              console.error('Error deleting argument:', error);
              alert('Error deleting argument');
            });
          }
        }
      });

      $('#saveEditFunction').on('click', function() {
        const functionId = $('#editFunctionId').val();
        const functionData = {
          name: $('#editFunctionName').val(),
          purpose: $('#editFunctionPurpose').val()
        };

        // Update function
        fetch(`/functions/${functionId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(functionData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'Function entry updated successfully') {
            // Update arguments
            const argRows = $('#functionArgsBody tr');
            const argPromises = argRows.map((index, row) => {
              const $row = $(row);
              const argId = $row.data('arg-id');
              const argData = {
                name: $row.find('[name="arg_name"]').val(),
                type: $row.find('[name="arg_type"]').val(),
                description: $row.find('[name="arg_description"]').val(),
                required: $row.find('[name="arg_required"]').is(':checked'),
                // Add enum if type is array
                enum: $row.find('[name="arg_type"]').val() === 'array' ? $row.find('[name="arg_enum"]').val() : undefined
              };

              if (typeof argId === 'string' && argId.startsWith('new_')) {
                return fetch(`/functions/${functionId}/args`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(argData)
                });
              } else {
                return fetch(`/functions/${functionId}/args/${argId}`, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(argData)
                });
              }
            }).get();

            Promise.all(argPromises)
              .then(() => {
                $('#editFunctionModal').modal('hide');
                location.reload();
              })
              .catch(error => {
                console.error('Error updating arguments:', error);
                alert('Error updating arguments');
              });
          } else {
            alert('Error updating function');
          }
        });
      });

      // Handle add function form submission
      $('#addFunctionForm').on('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        fetch('/functions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'Function entry created successfully') {
            location.reload();
          } else {
            alert('Error creating function');
          }
        });
      });

      // Handle edit function form submission
      $('#editFunctionForm').on('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        fetch('/functions', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
          if (data.message === 'Function entry updated successfully') {
            location.reload();
          } else {
            alert('Error updating function');
          }
        });
      });
    });
  </script>
</script>
{% endblock %}