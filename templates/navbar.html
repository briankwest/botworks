<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
  
    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <!-- Navbar Search -->
      <li class="nav-item">
        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
          <i class="fas fa-search"></i>
        </a>
        <div class="navbar-search-block">
          <form class="form-inline">
            <div class="input-group input-group-sm">
              <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
              <div class="input-group-append">
                <button class="btn btn-navbar" type="submit">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </li>
  
      <!-- Messages Dropdown Menu -->
      <li class="nav-item dropdown">
        <!-- Add messages dropdown menu items here -->
      </li>
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <!-- Add notifications dropdown menu items here -->
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <!-- AI Agent Selector -->
      <select id="agent-select" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" onchange="handleAgentChange(event)">
        <option value="">-- Select an Agent --</option>
        <!-- JavaScript will populate this list -->
      </select>
    </ul>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const agentSelect = document.getElementById('agent-select');

    fetch('{{ url_for("agents") }}', {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      const selectedAgentId = getCookie('selectedAgentId');

      data.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        if (agent.id == selectedAgentId) {
          option.selected = true;
        }
        agentSelect.appendChild(option);
      });

      if (!selectedAgentId && agentSelect.options.length > 1) {
        agentSelect.selectedIndex = 1;
        handleAgentChange({ target: agentSelect });
      }

      agentSelect.addEventListener('change', function() {
        const agentId = this.value;
        if (agentId) {
          document.cookie = `selectedAgentId=${agentId}; path=/; samesite=Strict`;
          location.reload();
        }
      });
    })
    .catch(error => console.error('Error fetching agents:', error));
  });

  function handleAgentChange(event) {
    const selectedAgentId = event.target.value;
    if (selectedAgentId) {
      console.log(`Selected agent: ${selectedAgentId}`);
      document.cookie = `selectedAgentId=${selectedAgentId}; path=/; samesite=Strict`;
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function refreshAgentsDropdown() {
    const agentSelect = document.getElementById('agent-select');
    agentSelect.innerHTML = '<option value="">-- Select an Agent --</option>'; // Clear existing options

    fetch('{{ url_for("agents") }}', {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('Fetched agents:', data); // Log the data for debugging
      if (Array.isArray(data)) {
        const selectedAgentId = getCookie('selectedAgentId'); // Get the selected agent ID from the cookie
        data.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent.id;
          option.textContent = agent.name;
          if (agent.id == selectedAgentId) {
            option.selected = true; // Select the option if it matches the cookie value
          }
          agentSelect.appendChild(option);
        });

        if (!agentSelect.querySelector('option[selected]') && agentSelect.options.length > 1) {
          agentSelect.options[1].selected = true;
          handleAgentChange({ target: agentSelect });
          document.cookie = `selectedAgentId=${agentSelect.value}; path=/; samesite=Strict`;
        }
      } else {
        console.error('Expected an array but got:', data);
      }
    })
    .catch(error => console.error('Error fetching agents:', error));
  }

  function delayedRefreshAgentsDropdown() {
    console.log('Delayed refresh agents dropdown');
    setTimeout(refreshAgentsDropdown, 500);
  }

  let refreshTimerId; 

  async function refreshToken() {
    const refreshToken = getCookie('refresh_token');
    if (!refreshToken) {
      console.error('Refresh token is missing');
      return;
    }

    const refreshResponse = await fetch('/refresh', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ refresh_token: refreshToken })
    });

    if (refreshResponse.ok) {
      const refreshData = await refreshResponse.json();
      document.cookie = `access_token=${refreshData.access_token}; path=/; samesite=Strict`;
      setRefreshTimer(refreshData.expires_in); 
    } else {
      console.error('Failed to refresh token');
    }
  }

function setRefreshTimer(expiresIn) {
  if (refreshTimerId) {
      clearTimeout(refreshTimerId); 
    }

    const refreshInterval = (expiresIn / 2) * 1000; 
    refreshTimerId = setTimeout(refreshToken, refreshInterval); 
  }

  const tokenExpiresIn = 30; 
  setRefreshTimer(tokenExpiresIn);
</script>
