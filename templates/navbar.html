<nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>
  
    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <!-- Navbar Search -->
      <li class="nav-item">
        <a class="nav-link" data-widget="navbar-search" href="#" role="button">
          <i class="fas fa-search"></i>
        </a>
        <div class="navbar-search-block">
          <form class="form-inline">
            <div class="input-group input-group-sm">
              <input class="form-control form-control-navbar" type="search" placeholder="Search" aria-label="Search">
              <div class="input-group-append">
                <button class="btn btn-navbar" type="submit">
                  <i class="fas fa-search"></i>
                </button>
                <button class="btn btn-navbar" type="button" data-widget="navbar-search">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </form>
        </div>
      </li>
  
      <!-- Messages Dropdown Menu -->
      <li class="nav-item dropdown">
        <!-- Add messages dropdown menu items here -->
      </li>
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <!-- Add notifications dropdown menu items here -->
      </li>
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <!-- AI Agent Selector -->
      <select id="agent-select" class="form-control" style="display: inline-block; width: auto; margin-left: 10px;" onchange="handleAgentChange(event)">
        <option value="">-- Select an Agent --</option>
        <!-- JavaScript will populate this list -->
      </select>
    </ul>
</nav>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const agentSelect = document.getElementById('agent-select');

    fetch('{{ url_for("agents") }}', {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      const selectedAgentId = getCookie('selectedAgentId');

      data.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        if (agent.id == selectedAgentId) {
          option.selected = true;
        }
        agentSelect.appendChild(option);
      });

      // Automatically select the first agent if no agent is selected
      if (!selectedAgentId && agentSelect.options.length > 1) {
        agentSelect.selectedIndex = 1; // Select the first agent (index 1, as index 0 is the placeholder)
        handleAgentChange({ target: agentSelect });
      }

      agentSelect.addEventListener('change', function() {
        const agentId = this.value;
        if (agentId) {
          document.cookie = `selectedAgentId=${agentId}; path=/;`;
          location.reload();
        }
      });
    })
    .catch(error => console.error('Error fetching agents:', error));
  });

  function handleAgentChange(event) {
    const selectedAgent = event.target.value;
    if (selectedAgent) {
      console.log(`Selected agent: ${selectedAgent}`);
      document.cookie = `selectedAgent=${selectedAgent}; path=/;`;
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function refreshAgentsDropdown() {
    const agentSelect = document.getElementById('agent-select');
    agentSelect.innerHTML = '<option value="">-- Select an Agent --</option>'; // Clear existing options

    fetch('{{ url_for("agents") }}', {
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('Fetched agents:', data); // Log the data for debugging
      if (Array.isArray(data)) {
        const selectedAgentId = getCookie('selectedAgentId'); // Get the selected agent ID from the cookie
        data.forEach(agent => {
          const option = document.createElement('option');
          option.value = agent.id;
          option.textContent = agent.name;
          if (agent.id == selectedAgentId) {
            option.selected = true; // Select the option if it matches the cookie value
          }
          agentSelect.appendChild(option);
        });
      } else {
        console.error('Expected an array but got:', data);
      }
    })
    .catch(error => console.error('Error fetching agents:', error));
  }

  // Function to delay the refresh
  function delayedRefreshAgentsDropdown() {
    setTimeout(refreshAgentsDropdown, 1000);
  }
</script>
