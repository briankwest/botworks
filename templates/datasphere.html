{% extends 'base.html' %}

{% block title %}DataSphere{% endblock %}

{% block content %}
  <!-- Navbar -->
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'sidebar.html' %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>DataSphere Documents</h1>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="card">
                <div class="card-header bg-primary">
                    <h3 class="card-title">Document List</h3>
                </div>
                <div class="card-body">
                    <table id="datasphereTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Filename</th>
                                <th>Status</th>
                                <th>Tags</th>
                                <th>Created At</th>
                                <th>Updated At</th>
                                <th>Number of Chunks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be populated here via AJAX -->
                        </tbody>
                    </table>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->

            <!-- Add Document Form Card -->
            <div class="card mt-5">
                <div class="card-header bg-primary">
                    <h3 class="card-title">Add New Document</h3>
                </div>
                <div class="card-body">
                    <form id="addDocumentForm">
                        <div class="form-group">
                            <label for="documentUrl">Document URL</label>
                            <input type="url" class="form-control" id="documentUrl" placeholder="Enter document URL" required>
                        </div>
                        <div class="form-group">
                            <label for="chunkingStrategy">Chunking Strategy</label>
                            <select class="form-control" id="chunkingStrategy" required>
                                <option value="sentence">Sentence</option>
                                <option value="sliding">Sliding</option>
                                <option value="paragraph">Paragraph</option>
                                <option value="page" selected>Page</option> <!-- Set default to page -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tags">Tags (comma separated)</label>
                            <input type="text" class="form-control" id="tags" placeholder="Enter tags">
                        </div>
                        <div id="sentenceOptions" class="chunking-options" style="display: none;">
                            <div class="form-group">
                                <label for="maxSentencesPerChunk">Max Sentences Per Chunk</label>
                                <input type="number" class="form-control" id="maxSentencesPerChunk" placeholder="Enter max sentences per chunk">
                            </div>
                            <div class="form-group">
                                <label for="splitNewlines">Split Newlines</label>
                                <input type="checkbox" id="splitNewlines">
                            </div>
                        </div>
                        <div id="slidingOptions" class="chunking-options" style="display: none;">
                            <div class="form-group">
                                <label for="chunkSize">Chunk Size</label>
                                <input type="number" class="form-control" id="chunkSize" placeholder="Enter chunk size">
                            </div>
                            <div class="form-group">
                                <label for="overlapSize">Overlap Size</label>
                                <input type="number" class="form-control" id="overlapSize" placeholder="Enter overlap size">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Document</button>
                    </form>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!-- Include AdminLTE footer -->
{% include 'footer.html' %}
<!-- /.footer -->
{% endblock %}

{% block scripts %}
<!-- Include DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function() {
        // Initialize DataTable
        $('#datasphereTable').DataTable({
            "ajax": {
                "url": "{{ url_for('datasphere') }}",
                "dataSrc": "data", // Assuming the data is in a 'data' array
                "headers": {
                    "Accept": "application/json",
                    "Content-Type": "application/json"
                }
            },
            "columns": [
                { "data": "id" },
                { "data": "filename" },
                { "data": "status" },
                { "data": "tags", "render": function(data) { return data.join(', '); } },
                { "data": "created_at" },
                { "data": "updated_at" },
                { "data": "number_of_chunks" },
                {
                    "data": null,
                    "render": function(data, type, row) {
                        return `
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary btn-sm edit-btn" data-id="${row.id}" style="margin-right: 5px;">Edit</button>
                                <button class="btn btn-danger btn-sm delete-btn" data-id="${row.id}">Delete</button>
                            </div>
                        `;
                    }
                }
            ],
            "responsive": true,
            "autoWidth": false
        });

        // Configure SweetAlert2 Toast
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // Edit button click event
        $('#datasphereTable').on('click', '.edit-btn', function() {
            var docId = $(this).data('id');
            
            // Get the row data
            var rowData = $('#datasphereTable').DataTable().row($(this).parents('tr')).data();
            
            // Populate the tags in the edit modal
            $('#editTags').val(rowData.tags.join(', '));
            
            // Store the document ID in a hidden field or a variable
            $('#editDocumentModal').data('docId', docId);
            
            // Show the modal
            $('#editDocumentModal').modal('show');
        });

        // Delete button click event
        $('#datasphereTable').on('click', '.delete-btn', function() {
            var docId = $(this).data('id');

            // Ask for confirmation before deleting
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: "/datasphere/documents/" + docId,
                        type: 'DELETE',
                        success: function(result) {
                            Toast.fire({
                                icon: 'success',
                                title: 'Document deleted successfully!'
                            });
                            $('#datasphereTable').DataTable().ajax.reload();
                        },
                        error: function(err) {
                            Toast.fire({
                                icon: 'error',
                                title: 'Failed to delete document.'
                            });
                        }
                    });
                }
            });
        });

        // Show/hide options based on selected chunking strategy
        $('#chunkingStrategy').change(function() {
            var strategy = $(this).val();
            $('.chunking-options').hide();
            if (strategy === 'sentence') {
                $('#sentenceOptions').show();
            } else if (strategy === 'sliding') {
                $('#slidingOptions').show();
            }
        });

        // Add Document Form submission
        $('#addDocumentForm').on('submit', function(event) {
            event.preventDefault();
            
            var documentUrl = $('#documentUrl').val();
            var chunkingStrategy = $('#chunkingStrategy').val();
            var tags = $('#tags').val().split(',').map(tag => tag.trim());

            var additionalOptions = {};
            if (chunkingStrategy === 'sentence') {
                additionalOptions.max_sentences_per_chunk = $('#maxSentencesPerChunk').val();
                additionalOptions.split_newlines = $('#splitNewlines').is(':checked');
            } else if (chunkingStrategy === 'sliding') {
                additionalOptions.chunk_size = $('#chunkSize').val();
                additionalOptions.overlap_size = $('#overlapSize').val();
            }

            $.ajax({
                url: "{{ url_for('datasphere') }}",
                type: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                data: JSON.stringify({
                    url: documentUrl,
                    chunking_strategy: chunkingStrategy,
                    tags: tags,
                    ...additionalOptions
                }),
                success: function(response) {
                    Toast.fire({
                        icon: 'success',
                        title: 'Document added successfully!'
                    });
                    $('#datasphereTable').DataTable().ajax.reload();
                },
                error: function(err) {
                    Toast.fire({
                        icon: 'error',
                        title: 'Failed to add document.'
                    });
                }
            });
        });

        // Edit Document Form submission
        $('#editDocumentForm').on('submit', function(event) {
            event.preventDefault();
            
            var docId = $('#editDocumentModal').data('docId');
            var updatedTags = $('#editTags').val().split(',').map(tag => tag.trim());

            $.ajax({
                url: "/datasphere/documents/" + docId,
                type: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                data: JSON.stringify({
                    tags: updatedTags
                }),
                success: function(response) {
                    Toast.fire({
                        icon: 'success',
                        title: 'Document updated successfully!'
                    });
                    $('#editDocumentModal').modal('hide');
                    $('#datasphereTable').DataTable().ajax.reload();
                },
                error: function(err) {
                    Toast.fire({
                        icon: 'error',
                        title: 'Failed to update document.'
                    });
                }
            });
        });
    });
</script>

<!-- Edit Document Modal -->
<div class="modal fade" id="editDocumentModal" tabindex="-1" role="dialog" aria-labelledby="editDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDocumentModalLabel">Edit Document</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editDocumentForm">
                    <div class="form-group">
                        <label for="editTags">Tags (comma separated)</label>
                        <input type="text" class="form-control" id="editTags" placeholder="Enter tags">
                    </div>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
