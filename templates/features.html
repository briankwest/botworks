{% extends 'base.html' %}

{% block title %}AI Features{% endblock %}

{% block content %}
  <!-- Navbar -->
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  {% include 'sidebar.html' %}
  
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-6">
                    <h1 class="m-0">AI Features</h1>
                </div>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary">
                            <h3 class="card-title">AI Features</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body table-responsive">
                            <table id="featuresTable" class="table table-striped w-100">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Value</th>
                                        <th>Enabled</th>
                                        <th>Created At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->

            <!-- Add Feature Card -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success">
                            <h3 class="card-title">Add New Feature</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body">
                            <form id="addFeatureForm">
                                <div class="form-group">
                                    <label for="featureName">Name</label>
                                    <input type="text" class="form-control" id="featureName" required>
                                </div>
                                <div class="form-group">
                                    <label for="featureValue">Value</label>
                                    <input type="text" class="form-control" id="featureValue">
                                </div>
                                <div class="form-group">
                                    <label for="featureEnabled">Enabled</label>
                                    <input type="checkbox" id="featureEnabled">
                                </div>
                                <button type="submit" class="btn btn-success">Add Feature</button>
                            </form>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.col -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <!-- Footer -->
  {% include 'footer.html' %}
  <!-- /.footer -->
{% endblock %}

{% block scripts %}
  <!-- Add DataTables CSS and JS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>

  <script>
    $(document).ready(function() {
      var selectedAgentId = getCookie('selectedAgentId'); // Retrieve the selected agent ID from cookies

      initializeFeaturesTable(selectedAgentId);

      // Add Feature Form Submission
      $('#addFeatureForm').on('submit', function(e) {
        e.preventDefault();
        const name = $('#featureName').val();
        const value = $('#featureValue').val();
        const enabled = $('#featureEnabled').is(':checked');
                
        $.ajax({
          url: `/aifeatures/${selectedAgentId}`, // Use selectedAgentId
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ name, value, enabled }),
          success: function() {
            $('#featuresTable').DataTable().ajax.reload(); // Reload the table data
            $('#addFeatureForm')[0].reset();
            Swal.fire('Success!', 'Feature added successfully.', 'success');
          },
          error: function() {
            Swal.fire('Error!', 'There was an error adding the feature.', 'error');
          }
        });
      });

      // Edit Feature Modal
      $(document).on('click', '.edit-btn', function() {
        const featureId = $(this).data('id');
        // Fetch feature data and populate modal fields
        $.get(`/aifeatures/${selectedAgentId}/${featureId}`, function(data) { // Use selectedAgentId
          $('#editFeatureId').val(data.id);
          $('#editFeatureName').val(data.name);
          $('#editFeatureValue').val(data.value);
          $('#editFeatureEnabled').prop('checked', data.enabled);
          $('#editFeatureModal').modal('show');
        });
      });

      // Edit Feature Form Submission
      $('#editFeatureForm').on('submit', function(e) {
        e.preventDefault();
        const id = $('#editFeatureId').val();
        const name = $('#editFeatureName').val();
        const value = $('#editFeatureValue').val();
        const enabled = $('#editFeatureEnabled').is(':checked');

        $.ajax({
          url: `/aifeatures/${selectedAgentId}/${id}`, // Use selectedAgentId
          type: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify({ name, value, enabled }),
          success: function() {
            $('#featuresTable').DataTable().ajax.reload();
            $('#editFeatureModal').modal('hide');
            Swal.fire('Success!', 'Feature updated successfully.', 'success');
          },
          error: function() {
            Swal.fire('Error!', 'There was an error updating the feature.', 'error');
          }
        });
      });
    });

    function initializeFeaturesTable(agentId) {
      if ($.fn.DataTable) {
        $('#featuresTable').DataTable({
          "ajax": {
            "url": `/aifeatures/${agentId}`, // Use agentId
            "dataSrc": "",
            "headers": {
              "Accept": "application/json"
            },
            "dataFilter": function(data) {
              console.log("AJAX Response:", data); // Log the response for debugging
              return data;
            }
          },
          "order": [[3, 'desc']], // Order by 'created_at' field
          "columns": [
            { "data": "id" },
            { "data": "name" },
            { "data": "value" },
            { "data": "enabled",
              "render": function(data, type, row) {
                return data ? 'Yes' : 'No';
              }
            },
            { "data": "created",
              "render": function(data, type, row) {
                return new Date(data).toLocaleString();
              }
            },
            { "data": null,
              "render": function(data, type, row) {
                return `
                  <button class="btn btn-primary edit-btn" data-id="${row.id}">Edit</button>
                  <button class="btn btn-danger delete-btn" data-id="${row.id}">Delete</button>
                `;
              }
            }
          ],
          "pageLength": 10,
          "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
          "responsive": true,
          "autoWidth": false
        });
      } else {
        console.error('DataTables is not loaded. Make sure you have included the DataTables library.');
      }

      $(document).on('click', '.delete-btn', function() {
        const featureId = $(this).data('id');
        Swal.fire({
          title: 'Are you sure?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: `/aifeatures/${agentId}/${featureId}`, // Use agentId
              type: 'DELETE',
              success: function() {
                $('#featuresTable').DataTable().ajax.reload();
                Swal.fire(
                  'Deleted!',
                  'The feature has been deleted.',
                  'success'
                );
              },
              error: function() {
                Swal.fire(
                  'Error!',
                  'There was an error deleting the feature.',
                  'error'
                );
              }
            });
          }
        });
      });
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
  </script>

  <!-- Edit Feature Modal -->
  <div class="modal fade" id="editFeatureModal" tabindex="-1" role="dialog" aria-labelledby="editFeatureModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editFeatureModalLabel">Edit Feature</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="editFeatureForm">
            <input type="hidden" id="editFeatureId">
            <div class="form-group">
              <label for="editFeatureName">Name</label>
              <input type="text" class="form-control" id="editFeatureName" required disabled>
            </div>
            <div class="form-group">
              <label for="editFeatureValue">Value</label>
              <input type="text" class="form-control" id="editFeatureValue">
            </div>
            <div class="form-group">
              <label for="editFeatureEnabled">Enabled</label>
              <input type="checkbox" id="editFeatureEnabled">
            </div>
            <button type="submit" class="btn btn-primary">Save changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
