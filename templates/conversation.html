{% extends 'base.html' %}

{% block title %}Conversations{% endblock %}

{% block content %}
{% include 'navbar.html' %}
{% include 'sidebar.html' %}

<div class="content-wrapper">
  <section class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-6">
          <h1 class="m-0">Conversations</h1>
        </div>
      </div>
    </div>
  </section>
  <section class="content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-primary">
              <h3 class="card-title">Conversations</h3>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table id="conversationsTable" class="table table-striped w-100">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Created</th>
                      <th>Caller ID Name</th>
                      <th>Caller ID Number</th>
                      <th class="text-nowrap text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div id="fullScreenModal" class="modal" role="dialog" aria-labelledby="modalTitle" aria-hidden="true" tabindex="-1"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:1050;">
    <div class="modal-content" tabindex="0" style="position:relative; width:100%; height:100%; overflow:auto;">
      <span class="close"
        style="position:fixed; top:10px; right:20px; font-size:30px; color:black; cursor:pointer; z-index:1100;">&times;</span>
      <div class="p-3">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-6">
                <h1 id="modalTitle" class="m-0">Conversation Details</h1>
              </div>
            </div>
          </div>
        </section>
        <section class="content">
          <div class="row">
            <div class="col-md-12">
              <div class="card card-primary">
                <div class="card-header bg-primary">
                  <h3 class="card-title">Interaction Details</h3>
                </div>
                <div class="card-body">
                  <div id="PostPromptDataContent"></div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Add a new modal for billing information -->
  <div id="billingModal" class="modal" role="dialog" aria-labelledby="billingModalTitle" aria-hidden="true" tabindex="-1"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8); z-index:1050;">
    <div class="modal-content" tabindex="0" style="position:relative; width:100%; height:100%; overflow:auto;">
      <span class="close"
        style="position:fixed; top:10px; right:20px; font-size:30px; color:black; cursor:pointer; z-index:1100;">&times;</span>
      <div class="p-3">
        <section class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-6">
                <h1 id="billingModalTitle" class="m-0">Billing Details</h1>
              </div>
            </div>
          </div>
        </section>
        <section class="content">
          <div class="row">
            <div class="col-md-12">
              <div class="card card-primary">
                <div class="card-header bg-primary">
                  <h3 class="card-title">Billing Information</h3>
                </div>
                <div class="card-body">
                  <div id="billingDataContent"></div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</div>

{% include 'footer.html' %}
{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  $(document).ready(function () {
    console.log('Document is ready');
    const agentId = {{ agent_id }};

    $('#conversationsTable').DataTable({
      "ajax": {
        "url": `/api/v1/agents/${agentId}/conversation`,
        "dataSrc": "",
        "headers": {
          "Accept": "application/json"
        }
      },
      "order": [[0, 'desc']],
      "columns": [
        { "data": "id" },
        {
          "data": "created",
          "render": function (data, type, row) {
            if (type === 'display' || type === 'filter') {
              const date = new Date(data);
              return date.toLocaleString();
            }
            return data;
          }
        },
        {
          "data": "data.caller_id_name",
          "render": function (data, type, row) {
            return data || 'N/A';
          }
        },
        {
          "data": "data.caller_id_number",
          "render": function (data, type, row) {
            return data || 'N/A';
          }
        },
        {
          "data": null,
          "render": function (data, type, row) {
            return `
                <div class="d-flex justify-content-end text-nowrap">
                  <button class="btn btn-primary btn-sm mr-2 view-conversation" data-id="${row.id}">
                    <i class="fas fa-eye"></i> View
                  </button>
                  <button class="btn btn-danger btn-sm mr-2 delete-conversation" data-id="${row.id}">
                    <i class="fas fa-trash-alt"></i> Delete
                  </button>
                </div>
              `;
          }
        }
      ],
      "responsive": true,
      "autoWidth": false,
      "paging": true,
      "lengthChange": true,
      "searching": true,
      "info": true,
      "error": function (xhr, error, thrown) {
        console.log('DataTables error: ', error);
        console.log('DataTables error details: ', thrown);
        console.log('Response text: ', xhr.responseText);
      },
      "columnDefs": [
        { "targets": -1, "className": "text-nowrap" }
      ]
    });

    function showToast(icon, title) {
      const Toast = Swal.mixin({
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.addEventListener('mouseenter', Swal.stopTimer)
          toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
      });

      Toast.fire({
        icon: icon,
        title: title
      });
    }

    $('#conversationsTable').on('click', '.delete-conversation', function () {
      const id = $(this).data('id');
      Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            type: 'DELETE',
            url: `/api/v1/agents/${agentId}/conversation/${id}`,
            success: function (response) {
              $('#conversationsTable').DataTable().ajax.reload();
              showToast('success', 'Conversation entry deleted successfully');
            },
            error: function (error) {
              showToast('error', 'Error deleting conversation entry');
            }
          });
        }
      });
    });

    $('#conversationsTable').on('click', '.view-conversation', function () {
      const id = $(this).data('id');
      const callId = $(this).data('call-id');
      $('#fullScreenModal').data('call-id', callId);

      $('#fullScreenModal').show();
      $('#fullScreenModal').attr('aria-hidden', 'false');
      $('#fullScreenModal').data('conversation-id', id);
      $('#fullScreenModal .modal-content').scrollTop(0);

      setTimeout(() => {
        $('#fullScreenModal').focus();
      }, 200);

      fetchData(agentId, id);

      $(document).on('focusin', function (e) {
        if ($('#fullScreenModal').is(':visible') && !$('#fullScreenModal').has(e.target).length) {
          $('#fullScreenModal').focus();
        }
      });

      $('.close').on('click', function () {
        $('#fullScreenModal').hide();
        $('#fullScreenModal').attr('aria-hidden', 'true');
        $(document).off('focusin');
      });
    });

    $(document).on('keydown', function (event) {
      if ($('#fullScreenModal').is(':visible')) {
        const modalContent = $('#fullScreenModal .modal-content');
        switch (event.key) {
          case 'ArrowLeft':
            $('#navContainer button:contains("Previous")').click();
            modalContent.scrollTop(0);
            setTimeout(() => {
              modalContent.focus();
            }, 100);
            break;
          case 'ArrowRight':
            $('#navContainer button:contains("Next")').click();
            modalContent.scrollTop(0);
            setTimeout(() => {
              modalContent.focus();
            }, 100);
            break;
          case 'ArrowUp':
            event.preventDefault();
            modalContent.scrollTop(modalContent.scrollTop() - 50);
            break;
          case 'ArrowDown':
            event.preventDefault();
            modalContent.scrollTop(modalContent.scrollTop() + 50);
            break;
          case 'PageUp':
            event.preventDefault();
            modalContent.scrollTop(modalContent.scrollTop() - modalContent.height());
            break;
          case 'PageDown':
            event.preventDefault();
            modalContent.scrollTop(modalContent.scrollTop() + modalContent.height());
            break;
          case 'Escape':
            $('#fullScreenModal').hide();
            break;
        }
      }
    });

    // Example trigger for fetching billing data
    $('#conversationsTable').on('click', '.view-billing', function () {
      const uuid = $(this).data('uuid');
      fetchBillingData(uuid);
    });

    $('.close').on('click', function () {
      $('#billingModal').hide();
      $('#billingModal').attr('aria-hidden', 'true');
    });
  });

  function fetchData(agentId, id) {

    console.log('Fetching data for ID:', id);
    fetch(`/api/v1/agents/${agentId}/conversation/${id}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(responseData => {
        console.log('Received data:', responseData);
        clearContent();
        if (responseData.cogs) {
          responseData.data.cogs = responseData.cogs;
        }
        if (responseData.grafana_url) {
          responseData.data.grafana_url = responseData.grafana_url;
        } 
        displayData(responseData.data);
        console.log('Setting up navigation buttons', agentId, responseData.next, responseData.prev, responseData.data.SWMLVars.record_call_url);
        setupNavigationButtons(agentId, responseData.next, responseData.prev, responseData.data.SWMLVars.record_call_url, id);
      })
      .catch(error => {
        console.error('Error fetching JSON:', error);
        fetch(`/api/v1/agents/${agentId}/conversation/${id}`)
          .then(response => response.text())
          .then(text => console.error('Response text:', text));
      });
  }

  function clearContent() {
    const content = document.getElementById('PostPromptDataContent');
    content.innerHTML = '';
  }

  function setupNavigationButtons(agentId, nextId, prevId, recordCallUrl, currentConversationId) {
    const content = document.getElementById('PostPromptDataContent');
    let navContainer = document.getElementById('navContainer');
    if (!navContainer) {
        navContainer = document.createElement('div');
        navContainer.id = 'navContainer';
        navContainer.className = 'd-flex justify-content-between align-items-center mb-3';
        content.insertAdjacentElement('beforebegin', navContainer);
    }
    navContainer.innerHTML = '';

    const navigationGroup = document.createElement('div');
    const actionsGroup = document.createElement('div');
    
    if (prevId) {
        const prevButton = document.createElement('button');
        prevButton.className = 'btn btn-primary btn-sm mr-2';
        prevButton.innerHTML = '<i class="fas fa-arrow-left"></i> Previous';
        prevButton.onclick = () => {
            fetchData(agentId, prevId);
        };
        navigationGroup.appendChild(prevButton);
    }

    if (nextId) {
        const nextButton = document.createElement('button');
        nextButton.className = 'btn btn-primary btn-sm';
        nextButton.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
        nextButton.onclick = () => {
            fetchData(agentId, nextId);
        };
        navigationGroup.appendChild(nextButton);
    }

    if (recordCallUrl) {
        const audio = new Audio(recordCallUrl);

        const playButton = document.createElement('button');
        playButton.className = 'btn btn-info btn-sm mr-2';
        playButton.innerHTML = '<i class="fas fa-play"></i> Play';
        playButton.onclick = () => {
            audio.play();
        };

        const pauseButton = document.createElement('button');
        pauseButton.className = 'btn btn-warning btn-sm mr-2';
        pauseButton.innerHTML = '<i class="fas fa-pause"></i> Pause';
        pauseButton.onclick = () => {
            audio.pause();
        };

        const stopButton = document.createElement('button');
        stopButton.className = 'btn btn-danger btn-sm mr-2';
        stopButton.innerHTML = '<i class="fas fa-stop"></i> Stop';
        stopButton.onclick = () => {
            audio.pause();
        };

        const restartButton = document.createElement('button');
        restartButton.className = 'btn btn-secondary btn-sm mr-2';
        restartButton.innerHTML = '<i class="fas fa-redo"></i> Restart';
        restartButton.onclick = () => {
            audio.currentTime = 0;
            audio.play();
        };

        actionsGroup.appendChild(playButton);
        actionsGroup.appendChild(pauseButton);
        actionsGroup.appendChild(stopButton);
        actionsGroup.appendChild(restartButton);

        const stopAudio = () => {
            audio.pause();
        };

        if (prevId) {
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-primary btn-sm mr-2';
            prevButton.innerHTML = '<i class="fas fa-arrow-left"></i> Previous';
            prevButton.onclick = () => {
                stopAudio();
                fetchData(agentId, prevId);
            };
            navigationGroup.appendChild(prevButton);
        }

        if (nextId) {
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-primary btn-sm';
            nextButton.innerHTML = 'Next <i class="fas fa-arrow-right"></i>';
            nextButton.onclick = () => {
                stopAudio();
                fetchData(agentId, nextId);
            };
            navigationGroup.appendChild(nextButton);
        }

        $('.close').on('click', stopAudio);
    }

    const downloadButton = document.createElement('button');
    downloadButton.className = 'btn btn-info btn-sm mr-2';
    downloadButton.innerHTML = '<i class="fas fa-download"></i> Download JSON';
    downloadButton.onclick = () => downloadConversationData(currentConversationId);
    actionsGroup.appendChild(downloadButton);

    const shareButton = document.createElement('button');
    shareButton.className = 'btn btn-success btn-sm';
    shareButton.innerHTML = '<i class="fas fa-share"></i> Share';
    shareButton.onclick = () => shareConversation(currentConversationId);
    actionsGroup.appendChild(shareButton);

    navContainer.appendChild(navigationGroup);
    navContainer.appendChild(actionsGroup);
  }

  function downloadConversationData(currentConversationId) {
    const agentId = window.location.href.split('/').slice(-2, -1)[0];

    fetch(`/api/v1/agents/${agentId}/conversation/${currentConversationId}`)
        .then(response => response.json())
        .then(data => {
            const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation_${currentConversationId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
        .catch(error => {
            console.error('Error downloading JSON:', error);
        });
  }

  function shareConversation(currentConversationId) {
    const currentUrl = window.location.href;
    const agentId = currentUrl.split('/').slice(-2, -1)[0];

    fetch(`/api/v1/agents/${agentId}/conversations/${currentConversationId}/share`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || 'Failed to create share link');
            });
        }
        return response.json();
    })
    .then(data => {
        const shareUrl = `${window.location.origin}/conversations/shared/${data.uuid}`;
        
        Swal.fire({
            title: 'Share Link Created',
            html: `
                <div class="input-group">
                    <input type="text" id="shareUrlInput" class="form-control" value="${shareUrl}" readonly>
                    <button class="btn btn-outline-secondary" onclick="copyShareUrl('${shareUrl}')">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            position: 'top-end',
            toast: true,
            timer: false
        });
    })
    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message,
            toast: true,
            position: 'top-end',
            timer: 3000,
            showConfirmButton: false
        });
    });
  }

  function copyShareUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        const copyButton = document.querySelector('.swal2-html-container .btn');
        copyButton.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        }, 1000);
    });
  }

  function displayData(data) {
    const content = document.getElementById('PostPromptDataContent');

    if (data) {      
      const interactionDetailsCard = createCard('Interaction Details', createInteractionDetailsTable(data), 'bg-info');
      content.appendChild(interactionDetailsCard);
    }

    if (data.raw_call_log) {
      const callLogCard = createCard('Call Log', createCallLogTable(data.raw_call_log), 'bg-success');
      content.appendChild(callLogCard);
    }

    if (data.times) {
      const timesCard = createCard('Times', createTimesTable(data.times), 'bg-warning');
      content.appendChild(timesCard);
    }

    if (data.SWMLVars) {
      const swmlVarsCard = createCard('SWML Vars', createSWMLVarsTable(data.SWMLVars), 'bg-danger');
      content.appendChild(swmlVarsCard);
    }

    if (data.swaig_log) {
      const swaigLogCard = createCard('SWAIG Log', createSwaigLogTable(data.swaig_log), 'bg-secondary');
      content.appendChild(swaigLogCard);
    }

    if (data.post_prompt_data) {
      const postPromptDataCard = createCard('Post Prompt Data', createPostPromptDataTable(data.post_prompt_data), 'bg-primary');
      content.appendChild(postPromptDataCard);
    }
  }

  function createCard(title, contentHtml, headerClass) {
    const card = document.createElement('div');
    card.className = 'card mb-3';

    const cardHeader = document.createElement('div');
    cardHeader.className = 'card-header ' + (headerClass || 'bg-info');

    cardHeader.dataset.cardWidget = 'collapse';
    
    const cardTitle = document.createElement('h5');
    cardTitle.className = 'card-title';
    cardTitle.innerText = title;

    cardHeader.appendChild(cardTitle);

    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';
    cardBody.innerHTML = contentHtml;

    card.appendChild(cardHeader);
    card.appendChild(cardBody);

    return card;
  }

  function createInteractionDetailsTable(data) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm">';
    table += `
        <tr>
            <th style="width: 45%;">Key</th>
            <th style="width: 45%;">Value</th>
            <th style="width: 5%;">Copy</th>
        </tr>
        <tr>
            <td>Call ID</td>
            <td>
                ${data.grafana_url ? `<a href="${data.grafana_url}" target="_blank">${data.call_id}</a>` : data.call_id}
                <button class="btn btn-warning btn-sm ml-2" onclick="fetchBillingData('${data.call_id}', this)">
                    <i class="fas fa-file-invoice-dollar"></i> Billing Details
                </button>
                <div id="billingDetails_${data.call_id}" class="billing-details" style="display: none;"></div>
            </td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.call_id || ''}')"></i></td>
        </tr>
        <tr>
            <td>Caller ID Name</td>
            <td>${data.caller_id_name || ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.caller_id_name || ''}')"></i></td>
        </tr>
        <tr>
            <td>Caller ID Number</td>
            <td>${data.caller_id_number || ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.caller_id_number || ''}')"></i></td>
        </tr>
        <tr>
            <td>Call Start Date</td>
            <td>${data.call_start_date ? new Date(data.call_start_date / 1000).toLocaleString() : ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.call_start_date ? new Date(data.call_start_date / 1000).toLocaleString() : ''}')"></i></td>
        </tr>
        <tr>
            <td>Call End Date</td>
            <td>${data.call_end_date ? new Date(data.call_end_date / 1000).toLocaleString() : ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.call_end_date ? new Date(data.call_end_date / 1000).toLocaleString() : ''}')"></i></td>
        </tr>
        <tr>
            <td>AI Start Date</td>
            <td>${data.ai_start_date ? new Date(data.ai_start_date / 1000).toLocaleString() : ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.ai_start_date ? new Date(data.ai_start_date / 1000).toLocaleString() : ''}')"></i></td>
        </tr>
        <tr>
            <td>AI End Date</td>
            <td>${data.ai_end_date ? new Date(data.ai_end_date / 1000).toLocaleString() : ''}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${data.ai_end_date ? new Date(data.ai_end_date / 1000).toLocaleString() : ''}')"></i></td>
        </tr>`;
    
        const additionalFields = [
      { key: 'Total Input Tokens', value: data.total_input_tokens },
      { key: 'Total Output Tokens', value: data.total_output_tokens },
      { key: 'Total ASR Cost Factor', value: data.total_asr_cost_factor },
      { key: 'Total ASR Minutes', value: data.total_asr_minutes },
      { key: 'Total Minutes', value: data.total_minutes },
      { key: 'Total TTS Chars', value: data.total_tts_chars },
      { key: 'Total TTS Chars Per Minute', value: data.total_tts_chars_per_min },
      { key: 'Total Wire Input Tokens', value: data.total_wire_input_tokens },
      { key: 'Total Wire Input Tokens Per Minute', value: data.total_wire_input_tokens_per_minute },
      { key: 'Total Wire Output Tokens', value: data.total_wire_output_tokens },
      { key: 'Total Wire Output Tokens Per Minute', value: data.total_wire_output_tokens_per_minute },
      { key: 'Version', value: data.version }
    ];

    if (data.cogs && data.total_tts_chars && data.total_asr_minutes && data.total_wire_input_tokens && data.total_wire_output_tokens) {
      const total_tts_cost = (data.total_tts_chars / 1000000) * data.cogs.tts_cog;
      const total_asr_cost = data.total_asr_minutes * data.cogs.asr_cog;
      const total_llm_in_cost = (data.total_wire_input_tokens / 1000000) * data.cogs.llm_in_cog;
      const total_llm_out_cost = (data.total_wire_output_tokens / 1000000) * data.cogs.llm_out_cog;
      const total_retail_cost = data.total_minutes * data.cogs.retail_pm;

      if (data.total_tts_chars) {
        additionalFields.push({ key: 'Total TTS Cost', value: total_tts_cost.toFixed(13) });
      }

      if (data.total_asr_minutes) {
        additionalFields.push({ key: 'Total ASR Cost', value: total_asr_cost.toFixed(13) });
      }

      if (data.total_wire_input_tokens) {
        additionalFields.push({ key: 'Total LLM In Cost', value: total_llm_in_cost.toFixed(13) });
      }

      if (data.total_wire_output_tokens) {
        additionalFields.push({ key: 'Total LLM Out Cost', value: total_llm_out_cost.toFixed(13) });
      }

      if (data.cogs) {
        const totalCog = total_tts_cost + total_asr_cost + total_llm_in_cost + total_llm_out_cost;
        additionalFields.push({ key: 'Total COG', value: totalCog.toFixed(13) });
      }

      if (data.total_minutes) {
        additionalFields.push({ key: 'Total Retail', value: total_retail_cost.toFixed(13) });
      }

      if (data.cogs ) {
        const totalCog = total_tts_cost + total_asr_cost + total_llm_in_cost + total_llm_out_cost;
        const totalRetail = data.total_minutes * data.cogs.retail_pm;
        const profit = totalRetail - totalCog;
        const profitMargin = totalRetail !== 0 ? (profit / totalRetail) * 100 : 0;

        additionalFields.push({ key: 'Profit Margin', value: profitMargin.toFixed(13) + '%' });
        additionalFields.push({ key: 'Profit', value: profit.toFixed(13) });
    }
    }

    additionalFields.forEach(field => {
      if (field.value !== undefined) {
        table += `
        <tr>
            <td>${field.key}</td>
            <td>${field.value}</td>
            <td class="copy-btn"><i class="fas fa-copy" onclick="copyToClipboard('${field.value}')"></i></td>
        </tr>`;
      }
    });

    table += '</table></div>';
    return table;
  }

  function createCallLogTable(callLog) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm" style="table-layout: fixed; width: 100%;">';
    table += `
            <tr>
                <th style="width: 10%;">Role</th>
                <th style="width: 65%;">Content</th>
                <th style="width: 5%;">Latency</th>
                <th style="width: 5%;">Audio Latency</th>
                <th style="width: 5%;">Utterance Latency</th>
            </tr>
        `;
    callLog.forEach((log, index) => {
      if (log.hasOwnProperty('tool_calls')) {
        return;
      }
      const roleColors = {
        'user': 'bg-primary text-white',
        'assistant': 'bg-success text-white',
        'system': 'bg-warning text-dark',
        'other': 'bg-secondary text-dark',
        'system-log': 'bg-warning text-dark',
        'tool': 'bg-info text-dark',
      };

      const roleClass = roleColors[log.role] || 'bg-light text-dark';

      table += `
                <tr class="${roleClass}">
                    <td class="role">${log.role}</td>
                    <td style="word-wrap: break-word;">${log.content.replace(/\n/g, '<br/>')}</td>
                    <td>${log.latency ? log.latency + ' ms' : 'N/A'}</td>
                    <td>${log.audio_latency ? log.audio_latency + ' ms' : 'N/A'}</td>
                    <td>${log.utterance_latency ? log.utterance_latency + ' ms' : 'N/A'}</td>
                </tr>
            `;
    });
    table += '</table></div>';

    // Add a canvas for the latency chart with reduced height
    table += '<canvas id="latencyChart" width="400" height="100"></canvas>';

    // Initialize the chart after the table
    setTimeout(() => {
      const ctx = document.getElementById('latencyChart').getContext('2d');
      const latencyData = interpolateMissingData(callLog.map(log => log.latency));
      const audioLatencyData = interpolateMissingData(callLog.map(log => log.audio_latency));
      const utteranceLatencyData = interpolateMissingData(callLog.map(log => log.utterance_latency));

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: callLog.map((_, index) => index + 1), // Use index as the label
          datasets: [
            {
              label: 'Latency',
              data: latencyData,
              borderColor: 'rgba(75, 192, 192, 0.6)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              fill: true,
              spanGaps: true, // Connect points with missing data
            },
            {
              label: 'Audio Latency',
              data: audioLatencyData,
              borderColor: 'rgba(153, 102, 255, 0.6)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              fill: true,
              spanGaps: true, // Connect points with missing data
            },
            {
              label: 'Utterance Latency',
              data: utteranceLatencyData,
              borderColor: 'rgba(255, 159, 64, 0.6)',
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              fill: true,
              spanGaps: true, // Connect points with missing data
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Log Entry'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Latency (ms)'
              }
            }
          }
        }
      });
    }, 0);

    return table;
  }

  function interpolateMissingData(data) {
    const interpolatedData = [...data];
    for (let i = 0; i < data.length; i++) {
      if (data[i] === undefined || data[i] === null) {
        let prev = i > 0 ? data[i - 1] : null;
        let next = null;
        for (let j = i + 1; j < data.length; j++) {
          if (data[j] !== undefined && data[j] !== null) {
            next = data[j];
            break;
          }
        }
        if (prev !== null && next !== null) {
          interpolatedData[i] = (prev + next) / 2;
        } else if (prev !== null) {
          interpolatedData[i] = prev;
        } else if (next !== null) {
          interpolatedData[i] = next;
        } else {
          interpolatedData[i] = null; // Leave as null to skip in chart
        }
      }
    }
    return interpolatedData;
  }

  function createTimesTable(times) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm">';
    table += `
            <tr>
                <th>Token Time</th>
                <th>Tokens</th>
                <th>TPS</th>
                <th>Avg TPS</th>
                <th>Response Word Count</th>
                <th>Response</th>
                <th>Answer Time</th>
            </tr>
        `;
    times.forEach(time => {
      table += `
                <tr>
                    <td>${time.token_time}</td>
                    <td>${time.tokens}</td>
                    <td>${time.tps}</td>
                    <td>${time.avg_tps}</td>
                    <td>${time.response_word_count}</td>
                    <td>${time.response}</td>
                    <td>${time.answer_time}</td>
                </tr>
            `;
    });
    table += '</table></div>';

    // Add canvases for the charts with reduced height
    table += `
      <canvas id="timeChart" width="400" height="100"></canvas>
      <canvas id="tokensChart" width="400" height="100"></canvas>
      <canvas id="tpsChart" width="400" height="100"></canvas>
    `;

    // Initialize the charts after the table
    setTimeout(() => {
      const timeCtx = document.getElementById('timeChart').getContext('2d');
      const tokensCtx = document.getElementById('tokensChart').getContext('2d');
      const tpsCtx = document.getElementById('tpsChart').getContext('2d');

      // Token Time and Answer Time Chart
      new Chart(timeCtx, {
        type: 'line',
        data: {
          labels: times.map((_, index) => index + 1),
          datasets: [
            {
              label: 'Token Time',
              data: times.map(time => time.token_time),
              borderColor: 'rgba(75, 192, 192, 0.6)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              fill: true,
              spanGaps: true,
            },
            {
              label: 'Answer Time',
              data: times.map(time => time.answer_time),
              borderColor: 'rgba(153, 102, 255, 0.6)',
              backgroundColor: 'rgba(153, 102, 255, 0.2)',
              fill: true,
              spanGaps: true,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Entry'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Time (s)'
              }
            }
          }
        }
      });

      // Tokens and Response Word Count Chart
      new Chart(tokensCtx, {
        type: 'line',
        data: {
          labels: times.map((_, index) => index + 1),
          datasets: [
            {
              label: 'Tokens',
              data: times.map(time => time.tokens),
              borderColor: 'rgba(255, 159, 64, 0.6)',
              backgroundColor: 'rgba(255, 159, 64, 0.2)',
              fill: true,
              spanGaps: true,
            },
            {
              label: 'Response Word Count',
              data: times.map(time => time.response_word_count),
              borderColor: 'rgba(54, 162, 235, 0.6)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: true,
              spanGaps: true,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Entry'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Count'
              }
            }
          }
        }
      });

      // TPS and Avg TPS Chart
      new Chart(tpsCtx, {
        type: 'line',
        data: {
          labels: times.map((_, index) => index + 1),
          datasets: [
            {
              label: 'TPS',
              data: times.map(time => time.tps),
              borderColor: 'rgba(255, 99, 132, 0.6)',
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              fill: true,
              spanGaps: true,
            },
            {
              label: 'Avg TPS',
              data: times.map(time => time.avg_tps),
              borderColor: 'rgba(75, 192, 192, 0.6)',
              backgroundColor: 'rgba(75, 192, 192, 0.2)',
              fill: true,
              spanGaps: true,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Entry'
              }
            },
            y: {
              title: {
                display: true,
                text: 'TPS'
              }
            }
          }
        }
      });

    }, 0);

    return table;
  }

  function createSWMLVarsTable(swmlVars) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm">';
    table += `
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>Copy</th>
            </tr>
        `;
    for (const [key, value] of Object.entries(swmlVars)) {
      table += `
                <tr>
                    <td>${key}</td>
                    <td>${value}</td>
                    <td class="copy-btn"><i class="fas fa-copy" data-copy="${value}" onclick="copyToClipboard('${value}')"></i></td>
                </tr>
            `;
    }
    table += '</table></div>';
    return table;
  }

  function createSwaigLogTable(swaigLog) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm">';
    table += `
      <tr>
        <th>URL</th>
        <th>Active Count</th>
        <th>Command Name</th>
        <th>Command Arg</th>
        <th>Post Data</th>
        <th>Post Response</th>
        <th>Epoch Time</th>
      </tr>
    `;

    swaigLog.forEach(log => {
      try {
        const commandArg = JSON.parse(log.command_arg || '{}');
        const postData = JSON.stringify(log.post_data, null, 2);
        const postResponse = JSON.stringify(log.post_response, null, 2);

        table += `
          <tr>
            <td>
              <input type="text" readonly value="${log.url}" style="width: 200px;">
              <i class="fas fa-copy copy-btn" data-copy="${log.url}" onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
            </td>
            <td>${log.active_count}</td>
            <td>${log.command_name}</td>
            <td>
              <textarea readonly style="width: 100%; max-width: 200px;">${JSON.stringify(commandArg, null, 2)}</textarea>
              <i class="fas fa-copy copy-btn" data-copy='${JSON.stringify(commandArg, null, 2)}' onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
            </td>
            <td>
              <textarea readonly style="width: 100%; max-width: 300px;">${postData}</textarea>
              <i class="fas fa-copy copy-btn" data-copy="${postData}" onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
            </td>
            <td>
              <textarea readonly style="width: 100%; max-width: 300px;">${postResponse}</textarea>
              <i class="fas fa-copy copy-btn" data-copy="${postResponse}" onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
            </td>
            <td class="nowrap">${new Date(log.epoch_time * 1000).toLocaleString()}</td>
          </tr>
        `;
      } catch (error) {
        console.error('Error parsing JSON in createSwaigLogTable:', error);
      }
    });

    table += '</table></div>';
    return table;
  }

  function createPostPromptDataTable(postPromptData) {
    let table = '<div class="table-responsive"><table class="table table-striped table-sm">';

    if (postPromptData.raw) {
      table += `
            <tr>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;"><strong>Raw Data:</strong></td>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;">${postPromptData.raw}</td>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;">
                  <i class="fas fa-copy copy-btn" data-copy='${JSON.stringify(postPromptData.raw, null, 2)}' onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
                </td>
            </tr>
            `;
    }

    if (postPromptData.substituted) {
      table += `
            <tr>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;"><strong>Substituted Data:</strong></td>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;">${postPromptData.substituted}</td>
                <td style="word-wrap: break-word; max-width: 100%; text-align: left;">
                  <i class="fas fa-copy copy-btn" data-copy='${JSON.stringify(postPromptData.substituted, null, 2)}' onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
                </td>
            </tr>
        `;
    }

    if (postPromptData.parsed && postPromptData.parsed.length > 0) {
      postPromptData.parsed.forEach((parsedItem, index) => {
        table += `
                <tr>
                    <td style="word-wrap: break-word; max-width: 100%; text-align: left;"><strong>Parsed Item ${index + 1}:</strong></td>
                    <td style="word-wrap: break-word; max-width: 100%; text-align: left;"><pre>${JSON.stringify(parsedItem, null, 2)}</pre></td>
                    <td style="word-wrap: break-word; max-width: 100%; text-align: left;">
                      <i class="fas fa-copy copy-btn" data-copy='${JSON.stringify(parsedItem, null, 2)}' onclick="copyToClipboard(this.getAttribute('data-copy'))"></i>
                    </td>
                </tr>
            `;
      });
    }

    table += '</table></div>';
    return table;
  }

  function fetchBillingData(callId, button) {
    const billingDetailsDiv = document.getElementById(`billingDetails_${callId}`);

    if (billingDetailsDiv.innerHTML.trim() !== '') {
        billingDetailsDiv.style.display = billingDetailsDiv.style.display === 'none' ? 'block' : 'none';
        return;
    }

    fetch(`/voice/logs/${callId}`)
        .then(response => response.json())
        .then(data => {
            const chargeDetails = data.charge_details;
            const labels = chargeDetails.map(detail => detail.description);
            const charges = chargeDetails.map(detail => detail.charge);

            billingDetailsDiv.innerHTML = `
                <div style="display: flex; flex-wrap: wrap; align-items: flex-start;">
                  <div style="flex: 1 1 300px; min-width: 300px;">
                    <table class="table table-bordered mt-2">
                        <tr><th>From</th><td>${data.from}</td></tr>
                        <tr><th>To</th><td>${data.to}</td></tr>
                        <tr><th>Direction</th><td>${data.direction}</td></tr>
                        <tr><th>Status</th><td>${data.status}</td></tr>
                        <tr><th>Duration</th><td>${data.duration} seconds</td></tr>
                        <tr><th>Charge</th><td>$${data.charge.toFixed(13)}</td></tr>
                    </table>
                  </div>
                  <div style="flex: 1 1 400px; padding-left: 20px; min-width: 400px;">
                    <canvas id="chargeChart_${callId}" width="400" height="400"></canvas>
                  </div>
                  <div style="flex: 1 1 300px; min-width: 300px; margin-left: 20px;">
                    <table class="table table-bordered mt-2">
                        <thead>
                          <tr>
                            <th>Description</th>
                            <th>Charge</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${chargeDetails.map(detail => `
                            <tr>
                              <td>${detail.description}</td>
                              <td>$${detail.charge.toFixed(13)}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                    </table>
                  </div>
                </div>
            `;
            billingDetailsDiv.style.display = 'block';

            const ctx = document.getElementById(`chargeChart_${callId}`).getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: charges,
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Charge Details'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error fetching billing data:', error);
        });
  }

  window.copyToClipboard = function (value) {
    const tempInput = document.createElement('textarea');
    tempInput.style.position = 'absolute';
    tempInput.style.left = '-9999px';
    tempInput.value = value;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    const Toast = Swal.mixin({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 1500,
      timerProgressBar: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    });

    Toast.fire({
      icon: 'success',
      title: 'Copied to clipboard'
    });
  }
</script>

{% endblock %}

